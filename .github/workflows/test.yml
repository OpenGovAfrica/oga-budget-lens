name: OpenGov Africa CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr ghostscript

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install quality tools explicitly to ensure they are available
          pip install ruff black pytest pytest-cov jsonschema mypy

      - name: Lint with Ruff
        run: |
          # Strictly enforce linting rules. Fails on errors.
          ruff check .

      - name: Check Formatting with Black
        run: |
          # Enforce code formatting. Fails if code is not formatted.
          black --check .

      - name: Type Check with Mypy
        run: |
          # Enforce type checking.
          mypy . --ignore-missing-imports --install-types --non-interactive

      - name: Validate JSON Data & Schemas
        run: |
          python -c "
          import json
          import glob
          import sys
          import os

          def validate_files(pattern, description):
              files = glob.glob(pattern, recursive=True)
              if not files:
                  print(f'‚ÑπÔ∏è No files found matching {pattern} ({description})')
                  return False
              
              has_error = False
              print(f'üîç Validating {len(files)} {description}...')
              for filepath in files:
                  try:
                      with open(filepath, 'r', encoding='utf-8') as f:
                          json.load(f)
                      print(f'  ‚úÖ Valid JSON: {filepath}')
                  except json.JSONDecodeError as e:
                      print(f'  ‚ùå Invalid JSON: {filepath}\n     Error: {e}')
                      has_error = True
                  except Exception as e:
                      print(f'  ‚ùå Error reading {filepath}: {e}')
                      has_error = True
              return has_error

          # Validate all JSON files in data/ and schemas/
          data_errors = validate_files('data/**/*.json', 'Data Files')
          schema_errors = validate_files('schemas/**/*.json', 'Schema Files')

          if data_errors or schema_errors:
              sys.exit(1)
          "

      - name: Run Tests with Pytest
        run: |
          # Check if tests exist before running to prevent empty run failure
          if pytest --collect-only > /dev/null 2>&1; then
            echo "‚úÖ Tests detected, running pytest..."
            pytest -v --cov=. --cov-report=term-missing --cov-fail-under=70
          else
            echo "‚ÑπÔ∏è No tests collected. Skipping pytest execution."
          fi
