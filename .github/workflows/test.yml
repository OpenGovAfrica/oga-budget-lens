name: CI Tests

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    name: Run Tests, Lint & Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr ghostscript

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Ensure dev dependencies are installed
          pip install flake8 pytest pytest-cov jsonschema mypy

      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Validate JSON Syntax
        run: |
          # Script to validate all JSON files in data/ directory
          python -c "
          import json
          import glob
          import sys

          files = glob.glob('data/**/*.json', recursive=True)
          if not files:
              print('No JSON files found in data/ to validate.')
              sys.exit(0)

          has_error = False
          for filepath in files:
              try:
                  with open(filepath, 'r') as f:
                      json.load(f)
                  print(f'✅ Valid usage of JSON syntax: {filepath}')
              except json.JSONDecodeError as e:
                  print(f'❌ Invalid JSON syntax: {filepath}\n   Error: {e}')
                  has_error = True

          if has_error:
              sys.exit(1)
          "

      - name: Run pytest
        run: |
          # Check for tests first
          if pytest --collect-only; then
            echo "Tests found, running pytest..."
            pytest -v --cov=./ --cov-report=term-missing
          else
            echo "No tests collected. Skipping pytest execution to prevent workflow failure."
          fi
